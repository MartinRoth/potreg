---
title: "Nonstationary Regional Frequency Analysis with Peaks-Over-Threshold Data"
author: "Martin Roth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, fig.show='hold'}
library(data.table)
library(ggplot2)
library(foreach)
library(iterators)
admNL <- raster::getData('GADM', country='NL', path="../inst/extdata", level=0)
fadmNL <- fortify(admNL)
if(!file.exists("../inst/extdata/NL_eobs_rr_0.50.rds")) {
  data  <- eobsR::importEOBS('rr', '1950/2015', admNL, "0.50reg")
  saveRDS(data, file = "../inst/extdata/NL_eobs_rr_0.50.rds")
} else {
  data <- readRDS("../inst/extdata/NL_eobs_rr_0.50.rds")
}
data <- data[month %in% c(1,2,12),]
data <- data[ !(year == 1950 & month %in% c(1,2)), ]

knitr::kable(head(data))
```

```{r, fig.show='hold', fig.cap="Mean winter maxima per grid box."}
ggplot(fadmNL, aes(x = long, y = lat, group = group)) +
  geom_path() + coord_map() + 
  geom_tile(aes(x = lon, y = lat, fill = mRR, group = NULL), data = 
              data[, .(RR = max(rr)),
                   by = .(year, lat, lon)][, .(mRR = mean(RR)),
                                           by = .(lat, lon)],
            alpha = 0.5) + 
  scale_fill_distiller(palette = "Spectral", guide =guide_legend(reverse=TRUE))
```

### Decluster the data
```{r, fig.show='hold'}
if(!file.exists("../inst/extdata/NL_eobs_rrSep_0.50.rds")) {
  julianDays <- as.numeric(data[pointID == 1, julian(time, origin=as.Date("1950-01-01"))])
  declusterData <- function(x) {
    index <- evanHelpers::declusterSimpleSeparation(julianDays, x, sep=1)
    x[-index] <- 0
    return(x)
  }
  data[, rrSep := declusterData(rr), by = pointID]
  saveRDS(data, file = "../inst/extdata/NL_eobs_rrSep_0.50.rds")
} else {
  data <- readRDS("../inst/extdata/NL_eobs_rrSep_0.50.rds")
}
knitr::kable(head(data))
```

### Compute the threshold
```{r, fig.show='hold'}
if(!file.exists("../inst/extdata/NL_eobs_threshold_0.50.rds")) {
  data[, threshold := -1]
  data[, pVal := -1]
  setkey(data, pointID)
  foreach(x=unique(data[["pointID"]]), .inorder=FALSE) %do% {
    fit <- data[.(x), quantreg::rq(rrSep ~ year, tau = 0.96)]
    data[.(x), threshold := fit$fitted.values]
    data[.(x), pVal := summary(fit)$coefficients[2, 4]]
  }
  saveRDS(data, file = "../inst/extdata/NL_eobs_threshold_0.50.rds")
} else {
  data <- readRDS("../inst/extdata/NL_eobs_threshold_0.50.rds")
}
knitr::kable(head(data))
```

```{r, fig.show='hold', fig.cap="Threshold statistics."}
ggplot(fadmNL, aes(x = long, y = lat, group = group)) +
  geom_path() + coord_map() + 
  geom_tile(aes(x = lon, y = lat, fill = mean, group = NULL), data = 
              data[, .(mean = mean(threshold)), by = .(lat, lon)],
            alpha = 0.5) + 
  scale_fill_distiller(palette = "Spectral", guide =guide_legend(reverse=TRUE))
ggplot(fadmNL, aes(x = long, y = lat, group = group)) +
  geom_path() + coord_map() + 
  geom_tile(aes(x = lon, y = lat, fill = trend, group = NULL),
            data = data[, .(trend = diff(range(threshold))*10/diff(range(year))),
                        by = .(lat, lon)],
            alpha = 0.5) + 
  geom_point(aes(x=lon, y = lat, group=NULL),
             shape = 1,
             data = data[, unique(pVal), by = .(lat, lon)][V1 < 0.05, ]) +
  scale_fill_distiller(palette = "Spectral", guide =guide_legend(reverse=TRUE))
```

### Set excesses

```{r, fig.show='hold'}
data[, pVal := NULL]
data[, excess := rrSep - threshold]
data[excess <= 0, excess := NA]
knitr::kable(head(data))
```

We expect `r data[, length(unique(year)) - 1] * (1 - 0.96) * 90.25` exceedances per grid box. The actual sample size varies between `r min(data[!is.na(excess), .N, by = pointID][, N])` and `r max(data[!is.na(excess), .N, by = pointID][, N])` exceedances per grid box. In total we observe `r data[, any(!is.na(excess)), by = time][, length(which(V1))]` days with at least one exceedance.

```{r, fig.show='hold'}
poissonData <- data[pointID == 1, .(time, year, excess)]
poissonData[, countExcesses := cumsum(!is.na(excess))]
ggplot(poissonData, aes(x = year, y = countExcesses)) + geom_line()
```

- reproduce figures 2, 7, 8, 9, 10, 11
- reproduce table 1 and 2

Most computations are to be found in "Dropbox/Work/Rwork/Scriptfiles/0_computation.R"
The corrections made after the review of the second paper are to be found in  "Dropbox/Work/Rwork/Scriptfiles/01_reviews.R"
Go also carfully over the functions in "Dropbox/Work/Rwork/Scriptfiles/0_all_functions.R"



Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
